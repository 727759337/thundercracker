# we expect $(TC_DIR)/firmware/master/Makefile.defs has already been included

all: $(BINS)

%.sim.o: %.cpp $(CDEPS)
	$(CC_SIM) -c -o $@ $< $(CCFLAGS_SIM)

%.stm32.o: %.cpp $(CDEPS)
	$(CC_STM32) -c -o $@ $< $(CCFLAGS_STM32)

ocd:
	openocd -f $(MASTER_DIR)/stm32/openocd.cfg

program: $(BIN_STM32)
	openocd -f $(MASTER_DIR)/stm32/openocd.cfg \
		-c init \
		-c "reset halt" \
		-c "flash write_image erase $<" \
		-c "reset run"

gdb:
	$(GDB_STM32) -x $(MASTER_DIR)/stm32/gdb.conf $(BIN_STM32)

sizeprof: $(BIN_STM32)
	nm --size-sort $(BIN_STM32) | egrep -v " [bB] " | arm-none-eabi-c++filt

$(BIN_SIM): $(OBJS_SIM) $(LIBS_SIM)
	$(CC_SIM) -o $@ $^ $(LDFLAGS_SIM)

$(BIN_STM32): $(OBJS_STM32) $(LIBS_STM32) $(LDSCRIPT_STM32)
	$(CC_STM32) -o $@ $(OBJS_STM32) $(LIBS_STM32) $(LDFLAGS_STM32)

$(ASSETS).gen.cpp: $(STIR) $(ASSETDEPS)
	$(STIR) $(ASSETS).lua -o $(ASSETS).gen.cpp -o $(ASSETS).gen.h -o $(ASSETS).html -v

$(AUDIO).gen.cpp: $(SPEEXENC) $(AUDIODEPS)
	$(SPEEXENC) -o $(AUDIO).gen.cpp -o $(AUDIO).gen.h $(AUDIO).txt

.PHONY: clean all ocd program gdb

clean:
	rm -f $(BINS) *.o *.d $(GENERATED_FILES)

-include $(OBJS_SIM:%.o=%.d)
-include $(OBJS_STM32:%.o=%.d)
	
