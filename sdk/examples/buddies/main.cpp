/* -*- mode: C; c-basic-offset: 4; intent-tabs-mode: nil -*-
 *
 * Copyright <c> 2012 Sifteo, Inc. All rights reserved.
 */

///////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////

#include <sifteo/event.h>
#include <sifteo/time.h>
#include "App.h"
#include "Config.h"

///////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////

using namespace Buddies;
using namespace Sifteo;

///////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////

namespace {

///////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////

App sApp;

///////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////

void OnNeighborAdd(void *, unsigned int c0, unsigned int s0, unsigned int c1, unsigned int s1)
{
    if (sApp.GetCubeWrapper(c0).IsEnabled() && sApp.GetCubeWrapper(c1).IsEnabled())
    {
        sApp.OnNeighborAdd(c0, Sifteo::Side(s0), c1, Sifteo::Side(s1));
    }
}

///////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////

void OnTilt(void *, unsigned cid)
{
    if (sApp.GetCubeWrapper(cid).IsEnabled())
    {
        sApp.OnTilt(cid);
    }
}

///////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////

void OnShake(void *, unsigned cid)
{
    if (sApp.GetCubeWrapper(cid).IsEnabled())
    {
        sApp.OnShake(cid);
    }
}

///////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////

}

///////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////

void main()
{
    Events::neighborAdd.set(&OnNeighborAdd);
    Events::cubeTilt.set(&OnTilt);
    Events::cubeShake.set(&OnShake);
    
    sApp.Init();
    sApp.Reset();
    
    SystemTime time = SystemTime::now();
    while (true)
    {
        TimeDelta dt = SystemTime::now() - time;
        time += dt;
        
        sApp.Update(dt);
        sApp.Draw();
    }
}

///////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////
