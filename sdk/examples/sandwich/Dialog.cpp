#include "Dialog.h"
#include "Game.h"
#include "DrawingHelpers.h"

static const uint8_t font_data[] = {
    0x05,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x02,0x00,0x01,0x01,0x01,0x01,0x01,0x00,0x01,0x00,
    0x04,0x00,0x05,0x05,0x00,0x00,0x00,0x00,0x00,0x00,
    0x07,0x00,0x12,0x3f,0x12,0x12,0x3f,0x12,0x00,0x00,
    0x08,0x14,0x7e,0x15,0x15,0x3e,0x54,0x54,0x3f,0x14,
    0x08,0x00,0x42,0x25,0x12,0x08,0x24,0x52,0x21,0x00,
    0x07,0x00,0x0c,0x12,0x12,0x0e,0x29,0x11,0x2e,0x00,
    0x02,0x00,0x01,0x01,0x01,0x00,0x00,0x00,0x00,0x00,
    0x04,0x00,0x06,0x01,0x01,0x01,0x01,0x01,0x06,0x00,
    0x04,0x00,0x03,0x04,0x04,0x04,0x04,0x04,0x03,0x00,
    0x06,0x04,0x15,0x0e,0x15,0x04,0x00,0x00,0x00,0x00,
    0x06,0x00,0x00,0x00,0x04,0x04,0x1f,0x04,0x04,0x00,
    0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x03,0x02,
    0x05,0x00,0x00,0x00,0x00,0x00,0x0f,0x00,0x00,0x00,
    0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x03,0x00,
    0x08,0x00,0x40,0x20,0x10,0x08,0x04,0x02,0x01,0x00,
    0x06,0x00,0x0e,0x11,0x19,0x15,0x13,0x11,0x0e,0x00,
    0x03,0x00,0x03,0x02,0x02,0x02,0x02,0x02,0x02,0x00,
    0x06,0x00,0x0f,0x10,0x1e,0x0e,0x01,0x01,0x1f,0x00,
    0x06,0x00,0x0f,0x10,0x1e,0x0e,0x10,0x10,0x0f,0x00,
    0x06,0x00,0x08,0x0c,0x0a,0x09,0x1f,0x08,0x08,0x00,
    0x06,0x00,0x1f,0x01,0x01,0x0f,0x10,0x10,0x0f,0x00,
    0x06,0x00,0x0e,0x01,0x01,0x0f,0x11,0x11,0x0e,0x00,
    0x06,0x00,0x1f,0x10,0x08,0x08,0x04,0x04,0x02,0x00,
    0x06,0x00,0x0e,0x11,0x11,0x0e,0x11,0x11,0x0e,0x00,
    0x06,0x00,0x0e,0x11,0x11,0x1e,0x10,0x10,0x0e,0x00,
    0x03,0x00,0x00,0x00,0x03,0x03,0x00,0x03,0x03,0x00,
    0x03,0x00,0x00,0x00,0x03,0x03,0x00,0x03,0x03,0x02,
    0x05,0x00,0x08,0x04,0x02,0x01,0x02,0x04,0x08,0x00,
    0x06,0x00,0x00,0x00,0x00,0x1f,0x00,0x1f,0x00,0x00,
    0x05,0x00,0x01,0x02,0x04,0x08,0x04,0x02,0x01,0x00,
    0x06,0x00,0x0e,0x11,0x10,0x08,0x04,0x00,0x04,0x00,
    0x08,0x00,0x3e,0x41,0x5d,0x55,0x7d,0x01,0x3e,0x00,
    0x06,0x00,0x0e,0x11,0x11,0x1f,0x11,0x11,0x11,0x00,
    0x06,0x00,0x0f,0x11,0x11,0x0f,0x11,0x11,0x0f,0x00,
    0x06,0x00,0x0e,0x11,0x01,0x01,0x01,0x11,0x0e,0x00,
    0x06,0x00,0x0f,0x11,0x11,0x11,0x11,0x11,0x0f,0x00,
    0x06,0x00,0x1f,0x01,0x01,0x0f,0x01,0x01,0x1f,0x00,
    0x06,0x00,0x1f,0x01,0x01,0x0f,0x01,0x01,0x01,0x00,
    0x06,0x00,0x0e,0x11,0x01,0x1d,0x11,0x11,0x0e,0x00,
    0x06,0x00,0x11,0x11,0x11,0x1f,0x11,0x11,0x11,0x00,
    0x04,0x00,0x07,0x02,0x02,0x02,0x02,0x02,0x07,0x00,
    0x06,0x00,0x10,0x10,0x10,0x10,0x10,0x11,0x0e,0x00,
    0x06,0x00,0x11,0x09,0x05,0x03,0x05,0x09,0x11,0x00,
    0x06,0x00,0x01,0x01,0x01,0x01,0x01,0x01,0x1f,0x00,
    0x07,0x00,0x21,0x33,0x2d,0x21,0x21,0x21,0x21,0x00,
    0x06,0x00,0x11,0x11,0x13,0x15,0x19,0x11,0x11,0x00,
    0x06,0x00,0x0e,0x11,0x11,0x11,0x11,0x11,0x0e,0x00,
    0x06,0x00,0x1f,0x11,0x11,0x11,0x0f,0x01,0x01,0x00,
    0x07,0x00,0x0e,0x11,0x11,0x11,0x11,0x19,0x1e,0x20,
    0x06,0x00,0x1f,0x11,0x11,0x11,0x0f,0x09,0x11,0x00,
    0x06,0x00,0x0e,0x11,0x01,0x0e,0x10,0x11,0x0e,0x00,
    0x06,0x00,0x1f,0x04,0x04,0x04,0x04,0x04,0x04,0x00,
    0x06,0x00,0x11,0x11,0x11,0x11,0x11,0x11,0x0e,0x00,
    0x06,0x00,0x11,0x11,0x11,0x11,0x0a,0x0a,0x04,0x00,
    0x08,0x00,0x41,0x41,0x49,0x49,0x2a,0x2a,0x14,0x00,
    0x06,0x00,0x11,0x11,0x0a,0x04,0x0a,0x11,0x11,0x00,
    0x06,0x00,0x11,0x11,0x11,0x0a,0x04,0x04,0x04,0x00,
    0x06,0x00,0x1f,0x10,0x08,0x04,0x02,0x01,0x1f,0x00,
    0x04,0x00,0x07,0x01,0x01,0x01,0x01,0x01,0x07,0x00,
    0x08,0x00,0x01,0x02,0x04,0x08,0x10,0x20,0x40,0x00,
    0x04,0x00,0x07,0x04,0x04,0x04,0x04,0x04,0x07,0x00,
    0x04,0x00,0x02,0x05,0x00,0x00,0x00,0x00,0x00,0x00,
    0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3f,0x00,
    0x03,0x00,0x01,0x02,0x00,0x00,0x00,0x00,0x00,0x00,
    0x06,0x00,0x00,0x00,0x0e,0x10,0x1e,0x11,0x1e,0x00,
    0x06,0x00,0x01,0x01,0x1f,0x11,0x11,0x11,0x0f,0x00,
    0x06,0x00,0x00,0x00,0x0f,0x11,0x01,0x11,0x0e,0x00,
    0x06,0x00,0x10,0x10,0x1f,0x11,0x11,0x11,0x1e,0x00,
    0x06,0x00,0x00,0x00,0x0e,0x11,0x1f,0x01,0x1e,0x00,
    0x05,0x00,0x0c,0x02,0x07,0x02,0x02,0x02,0x02,0x00,
    0x06,0x00,0x00,0x00,0x1f,0x11,0x11,0x11,0x1e,0x1e,
    0x06,0x00,0x01,0x01,0x0f,0x11,0x11,0x11,0x11,0x00,
    0x02,0x00,0x01,0x00,0x01,0x01,0x01,0x01,0x01,0x00,
    0x03,0x00,0x02,0x00,0x02,0x02,0x02,0x02,0x02,0x02,
    0x05,0x00,0x01,0x01,0x09,0x05,0x03,0x05,0x09,0x00,
    0x02,0x00,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x00,
    0x08,0x00,0x00,0x00,0x3f,0x49,0x49,0x49,0x49,0x00,
    0x06,0x00,0x00,0x00,0x0f,0x11,0x11,0x11,0x11,0x00,
    0x06,0x00,0x00,0x00,0x1f,0x11,0x11,0x11,0x0e,0x00,
    0x06,0x00,0x00,0x00,0x1f,0x11,0x11,0x11,0x0f,0x01,
    0x06,0x00,0x00,0x00,0x1f,0x11,0x11,0x11,0x1e,0x10,
    0x05,0x00,0x00,0x00,0x0d,0x03,0x01,0x01,0x01,0x00,
    0x06,0x00,0x00,0x00,0x1e,0x01,0x0e,0x10,0x0f,0x00,
    0x05,0x00,0x02,0x02,0x0f,0x02,0x02,0x02,0x0c,0x00,
    0x06,0x00,0x00,0x00,0x11,0x11,0x11,0x11,0x0e,0x00,
    0x06,0x00,0x00,0x00,0x11,0x11,0x0a,0x0a,0x04,0x00,
    0x08,0x00,0x00,0x08,0x49,0x49,0x49,0x49,0x36,0x00,
    0x06,0x00,0x00,0x00,0x11,0x0a,0x04,0x0a,0x11,0x00,
    0x06,0x00,0x00,0x00,0x11,0x11,0x11,0x11,0x1e,0x1e,
    0x06,0x00,0x00,0x00,0x1f,0x08,0x04,0x02,0x1f,0x00,
};
#define kFontHeight 9



Dialog::Dialog(Cube* pCube) : mCube(pCube) {
}

void Dialog::Init() {
    mCube->vbuf.poke(offsetof(_SYSVideoRAM, colormap) / 2 + 0, color_lerp(0));
    mCube->vbuf.poke(offsetof(_SYSVideoRAM, colormap) / 2 + 1, color_lerp(0));
    mCube->vbuf.pokeb(offsetof(_SYSVideoRAM, mode), _SYS_VM_FB128);
}

const char* Dialog::Show(const char* str) {
    unsigned count, length;
    MeasureText(str, &count, &length);
	mPosition.x = (128 - length) >> 1;
    DrawText(str);
    mPosition.y += kFontHeight + 1;
    return str + count;
}

void Dialog::DrawGlyph(char ch) {
    uint8_t index = ch - ' ';
    const uint8_t *data = font_data + (index * kFontHeight) + index;
    uint8_t escapement = *(data++);
    uint16_t dest = (mPosition.y << 4) | (mPosition.x >> 3);
    unsigned shift = mPosition.x & 7;

    for (unsigned i = 0; i < kFontHeight; i++) {
        mCube->vbuf.pokeb(dest, mCube->vbuf.peekb(dest) | (data[i] << shift));
        dest += 16;
    }

    if (shift) {
        dest += -16*kFontHeight + 1;
        shift = 8 - shift;

        for (unsigned i = 0; i < kFontHeight; i++) {
            mCube->vbuf.pokeb(dest, mCube->vbuf.peekb(dest) | (data[i] >> shift));
            dest += 16;
        }
    }

    mPosition.x += escapement;
}

unsigned Dialog::MeasureGlyph(char ch) {
    uint8_t index = ch - ' ';
    const uint8_t *data = font_data + (index * kFontHeight) + index;
    return data[0];
}

void Dialog::DrawText(const char *str) {
    char c;
    while ((c = *str) && c != '\n') {
        str++;
        DrawGlyph(c);
    }
}

void Dialog::MeasureText(const char *str, unsigned *outCount, unsigned *outPx) {
    *outPx = 0;
    *outCount = 0;
    char c;
    while ((c = *str) && c != '\n') {
        str++;
        (*outCount)++;
        *outPx += MeasureGlyph(c);
    }
    if (c) { (*outCount)++; }
}

void Dialog::Erase() {
    mPosition.y = 8;
    for (unsigned i = 0; i < sizeof mCube->vbuf.sys.vram.fb / 2; i++) {
    	mCube->vbuf.poke(i, 0);
    }
}

void Dialog::SetAlpha(uint8_t i) {
    mCube->vbuf.poke(
        offsetof(_SYSVideoRAM, colormap) / 2 + 1,
        color_lerp(i)
    );
}

void Dialog::ShowAll(const char* lines) {
    while(*lines) {
        lines = Show(lines);
    }
}
